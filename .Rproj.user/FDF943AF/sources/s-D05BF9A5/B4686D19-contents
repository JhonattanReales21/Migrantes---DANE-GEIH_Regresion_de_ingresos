library(tidyverse)

# Load the data

Poblacion_prueba <- read.csv("Dane_etapa_modelado.csv", sep = ",", header = T)
Familias <- Poblacion_prueba[,2]
Poblacion_prueba <- select(Poblacion_prueba, -c(1,2))

Departamentos <- c("Antioquia", "Atlantico", "Bogota", "Bolivar", "Boyaca", "Caldas",
                   "Caqueta", "Cauca", "Cesar", "Cordoba", "Cundinamarca", "Choco", 
                   "Huila", "La Guajira", "Magdalena", "Meta", "NariÃ±o", "Norte de Santander",
                   "Quindio", "Risaralda", "Santander", "Sucre", "Tolima", "Valle")

# Build the matrix of probabilities to be occupied

Probabilidades <- matrix(0,nrow(Poblacion_prueba),24)
colnames(Probabilidades) <- Departamentos
Prob_2 <- matrix(0,nrow(Poblacion_prueba),24)
colnames(Prob_2) <- Departamentos


# Leer modelo logistico general para DART_Y2
modelo_log <- readRDS("model.log_DART_Y2_GENERAL.rds")


for (Dep in Departamentos) {
  modelo <- readRDS(paste0("model_Y2_DART_NoGrid_", Dep, ".rds"))

  prob<-as.data.frame(predict(modelo,newdata = Poblacion_prueba,type = "prob"))[2]
  colnames(prob)<-c("x")
  prob_calibrated<-as.data.frame(predict(modelo_log,newdata = prob,type = "response"))[,1]
  
  Probabilidades[,Dep] <- prob_calibrated
  Prob_2[,Dep] <- prob$x
  
}

# Agreggated the family case 

Probabilidades <- cbind(Probabilidades, Familias)
Probabilidades<- as_tibble(Probabilidades)
Probabilidades <- dplyr::select(Probabilidades, 25, everything())


# Build the matrix of case level probabilities per departament

family_cases <- (unique(Probabilidades$Familias))

Prob_case_matrix <- matrix(0, length(family_cases), 25)
colnames(Prob_case_matrix) <- names(Probabilidades)

for (family in family_cases) {
  
  case <- filter(Probabilidades, Familias==family)
  
  for (Dep in Departamentos) {
    M1 <- select(case, Dep)
    
    prod <- 1-M1[1,] # We initialize the prod variable that will change depending in the amount of persons in the family
    
    if (nrow(M1) > 1) {
      for (i in nrow(M1)-1) {
        prod <- prod*(1-M1[i+1,]) # We make the productory of the probability that no one is ocuppied
      }
    } 
    
    Prob_case_matrix[family,Dep] <- as.numeric(1-prod) # Assign the prob of at least one person in the family is working
  }
}

Prob_case_matrix <- as_tibble(Prob_case_matrix)
Prob_case_matrix$Familias <- as_tibble(family_cases)


write.csv(Prob_case_matrix, "DART.Y2_Mapping_#1_Calibrated.csv")


